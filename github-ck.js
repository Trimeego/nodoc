var GitHubApi=require("github").GitHubApi,_=require("underscore"),jade=require("jade"),fs=require("fs"),yaml=require("js-yaml"),github=new GitHubApi(!0),program=require("commander"),https=require("https"),md=require("node-markdown").Markdown,PDFDocument=require("pdfkit"),dateFormat=require("node-dateformat"),repository,environment,docConfig,committedAfter,committedBefore;program.version("0.0.1").option("-r, --repo [repository]","The github repository to pull release docs for").option("-e, --env [environemnt]","The environment for which the release docs are being pulled").option("-f, --from [date]","Date to start capturing changes").option("-t, --to [date]","Date to stop capturing changes").option("-n, --title [title] ","The title of the release.").parse(process.argv);if(!program.from){console.log("You must provide a date.  Use --help.");process.exit()}else{committedAfter=Date.parse(program.from);if(!committedAfter){console.log("Invalid From Date");process.exit()}}if(!program.to)committedBefore=new Date;else{committedBefore=Date.parse(program.to);if(!committedBefore){console.log("Invalid To Date");process.exit()}}if(!program.repo){console.log("You must provide a repository.  Use --help.");process.exit()}else repository=program.repo;if(!program.env){console.log("You must provide an environment.  Use --help.");process.exit()}else environment=program.env;var queuedCommits=[],allFiles=[],callCount=0;docConfig=require(__dirname+"/"+repository+".yaml")[0],targetCommits=[];var pullApplicationDocs=function(a){var b=[],c=0,d=require("https"),e="";console.log("");console.log("Pulling Application Release Documents (release.md)");_.each(docConfig.applications,function(b){b.env=_.find(b.environments,function(a){return a.name.toLowerCase()===environment.toLowerCase()});c+=1;d.get({host:"raw.github.com",path:"/ICGGroup/Loves/master/"+b.githubPath+"/release.md?login=Trimeego&token=31e3e2e09d42e5362e143f9a3b64144e"},function(d){d.on("data",function(a){d.statusCode===200&&a&&a.toString()!=="undefined"&&(e+=a.toString())});d.on("end",function(){process.stdout.write(".");c-=1;if(d.statusCode===200){b.releaseNotes=md(e);b.rawReleaseNotes=e}c===0&&a()})}).on("error",function(b){c-=1;c===0&&a()})})},buildDoc=function(){var a=_.filter(docConfig.applications,function(a){return a.releaseNeeded}),b=[];_.each(a,function(a){_.each(a.env.servers,function(c){var d=_.find(b,function(a){return a.name===c.name});if(!d){d={name:c.name,applications:[]};b.push(d)}d.applications.push(a)})});var c=__dirname+"/templates/application.jade",d=fs.readFileSync(c,"utf8"),e=jade.compile(d,{filename:c,pretty:!0});fs.writeFile(__dirname+"/output/"+repository+".html",e({apps:a,servers:b,program:program}),function(a){a?console.log(a):console.log("\noutput saved to /output/"+repository+".html")});doc=new PDFDocument;doc.info.Title="Release Document";doc.info.Author="ICG Consulting";doc.font("Times-Roman");doc.image("images/icg.png",72,53,{fit:[150,67]});doc.image("images/"+repository+".png",380,72,{fit:[150,67]});doc.fontSize(25).text(program.title,106,300,{width:400,align:"center"});doc.fontSize(9).text("Repository:   "+repository,450,650);doc.fontSize(9).text("Environment:  "+environment);doc.fontSize(9).text("From Date:  "+program.from);program.to&&doc.fontSize(9).text("To Date:  "+program.to);doc.fontSize(9).text("Run Date:  "+dateFormat(new Date,"yyyy-mm-dd"));doc.addPage();doc.fontSize(18).fillColor("#274567").text("Release Summary");doc.moveDown();_.each(b,function(a){doc.fontSize(14).fillColor("#000000").text("Server: "+a.name);doc.moveDown();var b=doc.y;doc.fontSize(10).fillColor("#274567").text("Application",80,b,{width:170});doc.fontSize(10).fillColor("#274567").text("Release Path",255,b,{width:250});_.each(a.applications,function(a){b=doc.y;doc.fontSize(10).fillColor("#000000").text(a.name,80,b,{width:170});doc.fontSize(10).fillColor("#000000").text(a.localSourcePath,255,b,{width:250})})});doc.moveDown(2);_.each(a,function(a){doc.addPage();doc.fontSize(18).fillColor("#274567").text(a.name,72,doc.y).moveDown(.5);doc.fontSize(12).fillColor("#000000").text(a.description,72,doc.y);doc.moveDown(2);if(a.deploymentInstructions){doc.fontSize(14).fillColor("#4f81bd").text("Deployment Instructions",80).moveDown(.5);_.each(a.deploymentInstructions,function(a){doc.circle(85,doc.y+3.5,1.5).fillColor("#4f81bd");doc.fillAndStroke();doc.fontSize(10).fillColor("#000000").text(a.text,95,doc.y)});doc.moveDown()}if(a.env&&a.env.database){doc.fontSize(14).fillColor("#4f81bd").text("Database Information",80,doc.y).moveDown(.5);lineY=doc.y;doc.fontSize(10).fillColor("#000000").text("Server",80,lineY,{width:170});doc.fontSize(10).fillColor("#000000").text(a.env.database.server,155,lineY,{width:200});lineY=doc.y;doc.fontSize(10).fillColor("#000000").text("Database",80,lineY,{width:170});doc.fontSize(10).fillColor("#000000").text(a.env.database.dbName,155,lineY,{width:200});lineY=doc.y;doc.fontSize(10).fillColor("#000000").text("Scripts",80,lineY,{width:170});doc.fontSize(10).fillColor("#000000").text(a.releaseFiles.length,155,lineY,{width:200});doc.moveDown()}else{doc.fontSize(14).fillColor("#4f81bd").text("Deployment Target(s)",80).moveDown(.5);_.each(a.env.servers,function(a){lineY=doc.y;doc.fontSize(10).fillColor("#000000").text(a.name,80,lineY,{width:170});doc.fontSize(10).fillColor("#000000").text(a.appPath,155,lineY,{width:200})});doc.moveDown()}if(a.listFiles){doc.fontSize(14).fillColor("#4f81bd").text("Files",80,doc.y);_.each(a.releaseFiles,function(a){lineY=doc.y;doc.fontSize(9).fillColor("#000000").text(a.filename)})}});doc.write("output/"+repository+".pdf")},getCommits=function(a,b){process.stdout.write(".");github.getCommitApi().getBranchCommits("ICGGroup",repository,"master?page="+a,function(c,d){if(!d||d.length===0)b();else{var e=!0;d.forEach(function(a){var b=Date.parse(a.committed_date);b>committedAfter&&b<committedBefore?targetCommits.push(a):e=!1});e?getCommits(a+1,b):b()}})},getCommitDetails=function(a){callCount+=1;github.getCommitApi().getCommit("ICGGroup","Loves",a.id,function(a,b){callCount-=1;var c,d;a&&console.log(a);if(b){var e=[];b.added&&(e=_.union(e,b.added));b.modified&&(e=_.union(e,_.map(b.modified,function(a){return a.filename})));if(b.removed){var f=[];_.each(b.removed,function(a){var b=_.find(allFiles,function(b){return b.filename===a});b&&f.push(b)});allFiles=_.without(allFiles,f)}e=_.uniq(e);_.each(e,function(a){var c=Date.parse(b.committed_date),d=_.find(allFiles,function(b){return b.filename===a});if(d){var e=Date.parse(d.lastCommit.committed_date);if(c>e){d.lastCommit=b;d.lastCommitDate=c}}else allFiles.push({filename:a,lastCommit:b,lastCommitDate:c})})}process.stdout.write(".");callCount<10&&queuedCommits.length>0&&getCommitDetails(queuedCommits.pop());if(callCount==0&&queuedCommits.length===0){_.each(docConfig.applications,function(a){var b="release/apportal";a.releaseFiles=_.filter(allFiles,function(b){return b?b.filename.indexOf(a.githubPath)>-1&&b.filename.toLowerCase().indexOf(".ds_store")==-1:!1});a.releaseFiles=_.sortBy(a.releaseFiles,function(a){return a.lastCommitDate});a.releaseNeeded=a.releaseFiles.length>0});pullApplicationDocs(function(){buildDoc()})}})};console.log("Getting Commit List");getCommits(1,function(){console.log("");console.log("Getting Commit Details");targetCommits.forEach(function(a){callCount>10?queuedCommits.push(a):getCommitDetails(a)})});